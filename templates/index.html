<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>FA Unisex Salon</title>
    <!-- ‚úÖ Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
</head>
<body class="container py-3">

    <h1 class="mb-4 text-primary">üíà FA Unisex Salon</h1>
    {% for msg in get_flashed_messages() %}
      <div class="alert alert-warning">{{ msg }}</div>
    {% endfor %}   
    
<!-- üßæ Finalization Summary -->
<div id="finalization-summary">
  {% if session.finalized_summary %}
  <div class="card mt-3 shadow-sm">
    <div class="card-header bg-primary text-white">
      üßæ Finalization Summary
    </div>
    <div class="card-body">
      <h7>Customer: {{ session.finalized_summary.customer.Name }} ({{ session.finalized_summary.customer.Phone }})</h7>
      <table class="table table-striped table-sm mt-1">
        <thead>
          <tr>
            <th>Service</th>
            <th>Original</th>
            <th>Final</th>
            <th>Discount</th>
            <th>Balance</th>
          </tr>
        </thead>
        <tbody>
          {% for row in session.finalized_summary.rows %}
          <tr>
            <td>{{ row.name }}</td>
            <td>‚Çπ{{ row.original }}</td>
            <td>‚Çπ{{ row.final }}</td>
            <td>‚Çπ{{ row.discount }}</td>
            <td>‚Çπ{{ row.balance }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      <div class="mt-3">
        <span class="badge bg-secondary">Total ‚Çπ{{ session.finalized_summary.total }}</span>
        <span class="badge bg-success">Discount ‚Çπ{{ session.finalized_summary.discount }}</span>
        <span class="badge bg-info">Final ‚Çπ{{ session.finalized_summary.final }}</span>
        <span class="badge bg-warning text-dark">Balance ‚Çπ{{ session.finalized_summary.balance }}</span>
      </div>
    </div>
  </div>
  {% endif %}
</div>

<!-- üë§ Current Customer -->
<div class="card mt-3">
  <div class="card-header bg-light">üë§ Current Customer</div>
  <div class="card-body">
    <p id="customer-info">No customer scanned yet.</p>
    <div id="customer-status-slot"></div> <!-- ‚úÖ JS alerts go here -->
    <button class="btn btn-outline-danger btn-sm" onclick="resetCustomer()">Reset Customer</button>
  </div>
</div>


    <div class="mt-3">
      <button class="btn btn-info" onclick="loadTransactions(10)">Show Last 10 Transactions</button>
      <button class="btn btn-secondary" onclick="loadTransactions(20)">Show Last 20 Transactions</button>
      <div id="transactions" class="mt-3"></div>
    </div>

  <div class="accordion mt-3" id="transactionAccordion">
  <div class="accordion-item">
    <h2 class="accordion-header" id="headingTx">
      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTx" aria-expanded="false" aria-controls="collapseTx">
        Recent Transactions
      </button>
    </h2>
    <div id="collapseTx" class="accordion-collapse collapse" aria-labelledby="headingTx" data-bs-parent="#transactionAccordion">
      <div class="accordion-body" id="transactions">
        <!-- Transactions will be injected here by JS -->
      </div>
    </div>
  </div>
</div>

    <!-- üîç QR Scanner + üì± Mobile Lookup -->
    <div class="row mt-3">
      <div class="col-md-6">
        <div class="card">
          <div class="card-header">üì∑ Scan QR</div>
          <div class="card-body">
            <button class="btn btn-primary btn-sm mb-2" onclick="startQR()">Start Scanner</button>
            <div id="qr-reader"></div>
          </div>
        </div>
      </div>

      <div class="row mt-3">
      <div class="col-md-6">
        <div class="card">
          <div class="card-header">üì± Lookup by Mobile Number</div>
          <div class="card-body">
            
       <form id="lookup-form">
          <input type="text" id="phone-input" name="phone" class="form-control me-2" placeholder="Enter mobile number" required>
          <button type="submit" class="btn btn-success">Find</button>
       </form>

          </div>
        </div>
      </div>
    </div>
    </div>

    

    <!-- üßæ Selected Services -->
<div class="card mt-3">
  <div class="card-header">üßæ Selected Services</div>
  <div class="card-body">
    {% with messages = get_flashed_messages(category_filter=["services"]) %}
      {% if messages %}
        <div class="mt-2">
          {% for msg in messages %}
            <div class="alert alert-info alert-dismissible fade show" role="alert">
              {{ msg }}
              <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    {% if selected %}
      <ul class="list-group">
        {% for code in selected %}
          <li class="list-group-item">{{ services[code][0] }} ‚Çπ{{ services[code][1] }}</li>
        {% endfor %}
      </ul>
    {% else %}
      <p>No services selected yet.</p>
    {% endif %}
    <div class="mt-2">
      <a href="{{ url_for('undo_last') }}" class="btn btn-warning btn-sm">Undo Last</a>
      <form action="{{ url_for('finalize') }}" method="post" class="d-inline">
        <button type="submit" class="btn btn-primary btn-sm">Finalize & Log</button>
      </form>
    </div>
  </div>
</div>


    <!-- üíà Services -->
    <div class="card mt-3">
      <div class="card-header">üíà Services</div>
      <div class="card-body">
        {% for code, (name, price) in services.items() %}
          <a href="{{ url_for('add_service', code=code) }}" class="btn btn-outline-primary btn-sm m-1">
            {{ name }} ‚Çπ{{ price }}
          </a>
        {% endfor %}
      </div>
    </div>

    <!-- üí≥ Top-Up -->
<div class="card mt-3">
  <div class="card-header">üí≥ Top-Up</div>
  <div class="card-body">
    {% with messages = get_flashed_messages(category_filter=["topup"]) %}
      {% if messages %}
        <div class="mt-2">
          {% for msg in messages %}
            <div class="alert alert-info alert-dismissible fade show" role="alert">
              {{ msg }}
              <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <form action="/submit" method="post" class="row g-2">
      <input type="hidden" name="action" value="topup">
      <div class="col-md-4">
        <input type="text" class="form-control" name="amount" placeholder="Enter amount">
      </div>
      <div class="col-md-4">
        <select name="mode" class="form-select">
          <option value="add">Add to Balance</option>
          <option value="reset">Reset Balance</option>
        </select>
      </div>
      <div class="col-md-4">
        <button type="submit" class="btn btn-success">Top-Up</button>
      </div>
    </form>
  </div>
</div>


    <!-- üõ† Fix Mistakes -->
    <div class="card mt-3">
      <div class="card-header">üõ† Fix Mistakes</div>
      <div class="card-body">
        <!-- Delete Service -->
        <form action="/submit" method="post">
          <input type="hidden" name="action" value="delete">
          <select name="code" class="form-select mb-2">
            {% for code, (name, price) in services.items() %}
              <option value="{{ code }}">{{ name }} ‚Çπ{{ price }}</option>
            {% endfor %}
          </select>
          <button type="submit" class="btn btn-danger btn-sm">Delete</button>
        </form>
      </div>
    </div>


    <!-- üÜï Register New Customer -->
    <div class="card mt-3">
      <div class="card-header bg-light">üÜï New Customer?</div>
      <div class="card-body">
        <a href="{{ url_for('show_registration') }}" class="btn btn-outline-primary w-100">
          Register New Customer
        </a>
      </div>
    </div>

    <!-- üì∑ QR Scanner Script -->
    <script>
        function startQR() {
          const qr = new Html5Qrcode("qr-reader");
          qr.start(
              { facingMode: "environment" },
              { fps: 10, qrbox: 250 },
              (decodedText) => {
                  try {
                      const customer = JSON.parse(decodedText.trim());

                      fetch("/set_customer", {
                          method: "POST",
                          headers: { "Content-Type": "application/json" },
                          body: JSON.stringify({ customer })
                      })
                      .then(res => res.json())
                      .then(data => {
                          if (data.status === "success") {
                              document.getElementById("customer-info").innerText =
                                  "Customer: " + customer.Name + " (" + customer.Phone + ")";
                              //showAlert("success", data.message, ".customer-box", "loaded-alert");
                              //showAlert("success", `‚úÖ Customer loaded: ${customer.Name} (${customer.Phone})`, ".customer-box", "customer-status");
                              showCustomerStatus("success", `‚úÖ Customer loaded: ${customer.Name} (${customer.Phone})`);
                            } else {
                              //showAlert("danger", data.message, ".customer-box", "customer-status");
                              showCustomerStatus("danger", data.message);

                          }
                      });

                      qr.stop();
                  } catch (e) {
                      //showAlert("danger", "‚ùå Invalid QR format", ".customer-box", "customer-status");
                      showCustomerStatus("danger", "‚ùå Invalid QR format");
                    }
              }
          ).catch(err => {
              //showAlert("danger", "‚ùå Camera start failed: " + err, ".customer-box", "customer-status");
              showCustomerStatus("danger", "‚ùå Camera start failed: " + err);
          });
      }

function finalizeServices(summaryData) {
  if (!summaryData || !summaryData.rows) return;

  let html = `
    <h5>Finalization Summary</h5>
    <table class="table table-sm">
      <thead>
        <tr>
          <th>Service</th>
          <th>Original</th>
          <th>Final</th>
          <th>Discount</th>
          <th>Balance</th>
        </tr>
      </thead>
      <tbody>
  `;

  summaryData.rows.forEach(r => {
    html += `
      <tr>
        <td>${r.name}</td>
        <td>‚Çπ${r.original}</td>
        <td>‚Çπ${r.final}</td>
        <td>‚Çπ${r.discount}</td>
        <td>‚Çπ${r.balance}</td>
      </tr>
    `;
  });

  html += `
      </tbody>
    </table>
    <p class="fw-bold">
      Total ‚Çπ${summaryData.total} | Discount ‚Çπ${summaryData.discount} | 
      Final ‚Çπ${summaryData.final} | Balance ‚Çπ${summaryData.balance}
    </p>
  `;

  // ‚úÖ Inject into dedicated container
  const summaryBox = document.getElementById("finalization-summary");
  if (summaryBox) summaryBox.innerHTML = html;
}


function showCustomerStatus(type, message) {
  const slot = document.getElementById("customer-status-slot");
  if (!slot) return;

  const oldAlert = document.getElementById("customer-status");
  if (oldAlert) oldAlert.remove();

  const alertBox = document.createElement("div");
  alertBox.id = "customer-status";
  alertBox.className = `alert alert-${type} alert-dismissible fade show mt-2`;
  alertBox.role = "alert";
  alertBox.innerHTML = `
    ${message}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  `;
  slot.appendChild(alertBox);
}

/*
// ‚úÖ Make this global so buttons can access it
function loadTransactions(limit) {
  fetch("/customer_transactions")
    .then(res => res.json())
    .then(data => {
      if (data.status === "success") {
        const txs = data.transactions.slice(-limit);
        let html = "<h5>Recent Transactions</h5><ul class='list-group'>";

        txs.forEach(tx => {
          const price = tx.FinalPrice ?? 0;
          const icon = tx.ServiceName.startsWith("Deletion") ? "‚ùå" : "üíà";
          const priceColor = price > 0 ? "text-success fw-bold" : "text-muted";

          html += `<li class="list-group-item d-flex justify-content-between">
                     ${icon} ${tx.Date || tx.Timestamp || "Unknown"} - ${tx.ServiceName}
                     <span class="${priceColor}">‚Çπ${price} | Balance ‚Çπ${tx.BalanceAfter}</span>
                   </li>`;
        });

        if (txs.length === 0) {
          html += "<p class='text-muted'>No transactions found.</p>";
        } else {
          const total = txs.reduce((sum, tx) => sum + (tx.FinalPrice ?? 0), 0);
          html += `</ul><p class="mt-2 fw-bold">Total in this view: ‚Çπ${total}</p>`;
        }

        console.log("Injecting into #transactions:", html);
        const el = document.getElementById("transactions");
        if (el) {
          el.innerHTML = html;
          el.style.display = "block";
        } else {
          console.error("‚ùå #transactions element not found");
        }
      } else {
        //showAlert("danger", data.message, ".customer-box", "tx-error");
        showCustomerStatus("danger", data.message);
      }
    })
    .catch(err => {
      //showAlert("danger", "‚ùå Error: " + err, ".customer-box", "tx-error");
      showCustomerStatus("danger", "‚ùå Error: " + err);
    });
}
    */

// ‚úÖ Make this global so buttons can access it
// ‚úÖ Make this global so buttons can access it
// ‚úÖ Make this global so buttons can access it
function loadTransactions(limit) {
  fetch("/customer_transactions")
    .then(res => res.json())
    .then(data => {
      console.log("Transactions response:", data);  // Debug log

      if (data.status === "success") {
         const txs = data.transactions;  // ‚úÖ use full array

        let html = "<h5>Recent Transactions</h5><ul class='list-group'>";

        txs.forEach(tx => {
          // ‚úÖ Use exact keys from JSON
          const price = tx["FinalPrice"] ?? tx["Credit"] ?? 0;
          let icon = "üíà"; // default for services
          if (tx["ServiceName"] && tx["ServiceName"].startsWith("Deletion")) {
            icon = "‚ùå";
          } else if (tx["ServiceName"] === "Top-Up") {
            icon = "üí≥";
          }

          const priceColor = price > 0 ? "text-success fw-bold" : "text-muted";

          html += `<li class="list-group-item d-flex justify-content-between">
                     ${icon} ${tx["Date"] || "Unknown"} - ${tx["ServiceName"]}
                     <span class="${priceColor}">‚Çπ${price} | Balance ‚Çπ${tx["BalanceAfter"]}</span>
                   </li>`;
        });

        if (txs.length === 0) {
          html += "<p class='text-muted'>No transactions found.</p>";
        } else {
          const total = txs.reduce((sum, tx) => sum + (tx["FinalPrice"] ?? tx["Credit"] ?? 0), 0);
          html += `</ul><p class="mt-2 fw-bold">Total in this view: ‚Çπ${total}</p>`;
        }

        console.log("Injecting into #transactions:", html);
        const el = document.getElementById("transactions");
        if (el) {
          el.innerHTML = html;
          el.style.display = "block";
        } else {
          console.error("‚ùå #transactions element not found");
        }
      } else {
        showCustomerStatus("danger", data.message);
      }
    })
    .catch(err => {
      showCustomerStatus("danger", "‚ùå Error: " + err);
    });
} 

// ‚úÖ Keep this inside DOMContentLoaded
document.addEventListener("DOMContentLoaded", function () {
  const collapseTx = document.getElementById("collapseTx");
  if (collapseTx) {
    collapseTx.addEventListener("shown.bs.collapse", function () {
      console.log("‚úÖ Accordion expanded ‚Äî calling loadTransactions");
      loadTransactions(10);
    });
  } else {
    console.error("‚ùå #collapseTx not found");
  }
});




  function resetCustomer() {
  fetch("/reset_customer", { method: "POST" })
    .then(res => res.json())
    .then(data => {
      if (data.status === "success") {
        document.getElementById("customer-info").innerText = "No customer scanned yet.";
        clearCustomerStatus();

        // ‚úÖ Clear summary
        const summaryBox = document.getElementById("finalization-summary");
        if (summaryBox) summaryBox.innerHTML = "";

        // ‚úÖ Clear transactions
        const txBox = document.getElementById("transactions");
        if (txBox) txBox.innerHTML = "";

      } else {
        showCustomerStatus("danger", "‚ùå Reset failed");
      }
    });
}

function showAlert(type, message, targetSelector = ".customer-box", alertId = null) {
  const container = document.querySelector(targetSelector);
  if (!container) return;

  // Use provided alertId if given, otherwise auto-generate based on type
  const id = alertId || `alert-${type}`;

  // Remove any existing alert with same ID
  const oldAlert = document.getElementById(id);
  if (oldAlert) oldAlert.remove();

  // Create new Bootstrap alert
  const alertBox = document.createElement("div");
  alertBox.id = id;
  alertBox.className = `alert alert-${type} alert-dismissible fade show mt-2`;
  alertBox.role = "alert";
  alertBox.innerHTML = `
    ${message}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  `;

  container.appendChild(alertBox);
}
    // Load customer info if already set in session
    fetch("/get_customer")
        .then(res => res.json())
        .then(data => {
            if (data.customer) {
                document.getElementById("customer-info").innerText =
                    "Customer: " + data.customer.Name + " (" + data.customer.Phone + ")";
            }
        });
/*
  function showAlert(type, message, targetSelector = ".customer-box", alertId = "dynamic-alert") {
      const oldAlert = document.getElementById(alertId);
      if (oldAlert) oldAlert.remove();

      const alertBox = document.createElement("div");
      alertBox.id = alertId;
      alertBox.className = `alert alert-${type} alert-dismissible fade show mt-2`;
      alertBox.role = "alert";
      alertBox.innerHTML = `
          ${message}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      `;

      const target = document.querySelector(targetSelector);
      if (target) target.appendChild(alertBox);
  }
*/


function clearAllAlerts() {
  document.querySelectorAll(".alert").forEach(alert => alert.remove());
}


function clearCustomerStatus() {
  const oldAlert = document.getElementById("customer-status");
  if (oldAlert) oldAlert.remove();
}

  function lookupByPhone(phone) {
    fetch("/lookup_customer", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: "phone=" + encodeURIComponent(phone)
    })
    .then(res => res.json())
    .then(data => {
        if (data.status === "success") {
            // ‚úÖ Show name + phone + balance
            document.getElementById("customer-info").innerText =
                `Customer: ${data.customer.Name} (${data.customer.Phone}) | Balance ‚Çπ${data.balance}`;

            //showAlert("success", data.message, ".customer-box", "customer-status");
            //showCustomerStatus("success", data.message);
             clearCustomerStatus(); // ‚úÖ remove any old alert
        } else {
            //showAlert("danger", data.message, ".customer-box", "customer-status");
            showCustomerStatus("danger", data.message);
        }
    })
    .catch(err => {
        //showAlert("danger", "‚ùå Error: " + err, ".customer-box", "customer-status");
        showCustomerStatus("danger", "‚ùå Error: " + err);
    });
}

  // ‚úÖ Attach listener after DOM is ready
  document.getElementById("lookup-form").addEventListener("submit", function(e) {
      e.preventDefault();
      const phone = document.getElementById("phone-input").value;
      lookupByPhone(phone);
  });
 
</script>


</body>
</html>